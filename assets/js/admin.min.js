(i=>{i(document).ready(function(){WSAAdmin.init()}),window.WSAAdmin={init:function(){this.bindEvents(),this.checkElementsExist(),this.initializePluginFilter()},bindEvents:function(){this.initTabs(),i(document).on("keydown",".wsa-tab-nav .nav-tab",this.handleTabKeyboard),i(document).on("click","#wsa-quick-scan",this.scanSite),i(document).on("click","#wsa-quick-ai-analysis",this.getAIRecommendations),i(document).on("click","#wsa-scan-plugins",this.scanSite),i(document).on("click","#wsa-scan-theme",this.scanSite),i(document).on("click","#wsa-scan-system",this.systemScan),i(document).on("click","#wsa-scan-integrations",this.scanSite),i("#wsa-system-scan").length,i(document).on("click","#wsa-scan-site",this.scanSite),i(document).on("click","#wsa-system-scan",this.systemScan),i(document).on("click","#wsa-get-recommendations",this.getAIRecommendations),i(document).on("click","#wsa-test-api",this.testAPIConnection),i(document).on("change","#wsa-show-all-plugins",this.togglePluginFilter),i(document).on("click","#wsa-expand-plugins-view",this.togglePluginExpansion),i(document).on("click",".wsa-clickable-stat",this.handleStatClick),i(document).on("click",".wsa-clickable-metric",this.handleStatClick),i(document).on("keydown",".wsa-clickable-metric",function(s){"Enter"!==s.key&&" "!==s.key||(s.preventDefault(),i(this).click())}),i(document).on("click",".wsa-view-details-btn",this.handleViewIntegrationDetails),i(document).on("click",".wsa-setup-guide-btn",this.handleShowSetupGuide),i(document).on("click",".wsa-view-integration-details",this.handleViewIntegrationDetailsDashboard),i(document).on("click",".wsa-show-setup-guide",this.handleShowSetupGuideDashboard),i(document).on("click","#wsa-send-test-report",this.sendTestReport),i(document).on("click","#wsa-preview-report",this.previewReport),i(document).on("click","#wsa-system-scan-modal .wsa-modal-close, #wsa-system-modal-close-btn",this.closeSystemScanModal),i(document).on("click","#wsa-run-new-system-scan",this.runNewSystemScan),i(document).on("click","#wsa-site-scan-modal .wsa-modal-close, #wsa-site-modal-close-btn",this.closeSiteScanModal),i(document).on("click","#wsa-run-new-site-scan",this.runNewSiteScan),i(document).on("click","#wsa-ai-results-modal .wsa-modal-close, #wsa-modal-close-btn, #wsa-modal-backdrop",this.hideModal.bind(this)),i(document).on("click",".wsa-view-results-btn",this.handleViewResults.bind(this)),i(document).on("click",".wsa-ai-feature-btn",this.handleAIFeatureAction),i(document).on("click","#create-test-results",this.handleCreateTestResults.bind(this)),i(document).ajaxError(this.handleAjaxError)},checkElementsExist:function(){var s;i("#wsa-scan-site").length&&this.initializeDashboard(),"undefined"!=typeof wsa_ajax&&wsa_ajax.has_pro&&(0<i(".wsa-ai-dashboard-card").length||0<i(".wsa-view-results-btn").length)&&(s=this,setTimeout(function(){s.initViewResultsButtons()},100))},togglePluginFilter:function(s){var s=i(s.target),e=i(".wsa-plugins-grid"),a=i(".wsa-total-count"),t=i(".wsa-filtered-count"),s=s.is(":checked"),e=(s?(e.addClass("wsa-show-all"),a.show(),t.hide()):(e.removeClass("wsa-show-all"),a.hide(),t.show()),i("#wsa-plugins-section-title")),a=s?wsa_ajax.strings.all_plugins_text:wsa_ajax.strings.filtered_plugins_text,t=e.find(".dashicons"),s=e.find(".wsa-count:visible"),t=t.length?t[0].outerHTML:"",s=s.length?s[0].outerHTML:"";e.html(t+" "+a+" "+s)},initializePluginFilter:function(){var s=i(".wsa-plugins-grid"),e=i("#wsa-show-all-plugins"),a=i(".wsa-total-count"),t=i(".wsa-filtered-count");e.length&&s.length&&(e.prop("checked",!1),s.removeClass("wsa-show-all"),a.hide(),t.show(),s.find(".wsa-plugin-card").css("transition","opacity 0.3s ease, transform 0.3s ease")),this.initializeExpandCollapse()},initializeExpandCollapse:function(){var e=this;i(document).on("click","#wsa-expand-plugins-view",function(s){s.preventDefault(),e.togglePluginExpansion()}),this.updateExpandCollapseState()},togglePluginExpansion:function(){var s=i("#wsa-expand-plugins-view"),e=i(".wsa-plugins-grid");!0===s.data("expanded")||"true"===s.data("expanded")?(e.find(".wsa-plugin-card").each(function(s){(parseInt(e.data("initial-count"))||8)<=s&&i(this).addClass("wsa-plugin-hidden").slideUp(300)}),s.data("expanded",!1),this.updateExpandCollapseButton(!1)):(e.find(".wsa-plugin-card.wsa-plugin-hidden").removeClass("wsa-plugin-hidden").slideDown(300),s.data("expanded",!0),this.updateExpandCollapseButton(!0))},updateExpandCollapseButton:function(s){var e=i("#wsa-expand-plugins-view"),a=e.find(".dashicons"),t=(e.contents().not(a).not(".wsa-remaining-count"),e.find(".wsa-remaining-count"));s?(a.removeClass("dashicons-arrow-down-alt2").addClass("dashicons-arrow-up-alt2"),e.contents().filter(function(){return 3===this.nodeType}).last().replaceWith(" Show Less "),t.hide()):(a.removeClass("dashicons-arrow-up-alt2").addClass("dashicons-arrow-down-alt2"),e.contents().filter(function(){return 3===this.nodeType}).last().replaceWith(" Show All "),t.show())},updateExpandCollapseState:function(){var s=i(".wsa-plugins-grid"),e=i("#wsa-expand-plugins-view"),a=parseInt(s.data("initial-count"))||8,s=s.find(".wsa-plugin-card:visible").length,s=Math.max(0,s-a);e.find(".wsa-remaining-count").text("(+"+s+" more)"),s<=0?e.hide():e.show()},handleStatClick:function(s){s.preventDefault();var e,a,t,n=i(s.currentTarget),s=n.data("tab");s&&(a=(t=(e=i('.wsa-tab-nav .nav-tab[data-tab="'+s+'"]')).closest(".wsa-tab-nav")).siblings(".wsa-tab-content"),e.length)&&a.length&&(t.find(".nav-tab").removeClass("nav-tab-active"),e.addClass("nav-tab-active"),a.find(".wsa-tab-panel").removeClass("wsa-tab-panel-active"),a.find("#wsa-"+s).addClass("wsa-tab-panel-active"),localStorage.setItem("wsa_active_tab",s),i(document).trigger("wsa:tabChanged",[s]),(t=i("#wsa-"+s)).length&&i("html, body").animate({scrollTop:t.offset().top-50},300),n.addClass("wsa-stat-clicked"),setTimeout(function(){n.removeClass("wsa-stat-clicked")},200))},handleViewIntegrationDetails:function(s){s.preventDefault();var s=i(s.currentTarget),e=s.data("service"),s=s.data("integration");this.showIntegrationDetailsModal(e,s)},handleShowSetupGuide:function(s){s.preventDefault();var s=i(s.currentTarget),e=s.data("service"),s=s.data("service-name");this.showIntegrationSetupModal(e,s)},handleViewIntegrationDetailsDashboard:function(s){s.preventDefault();var s=i(s.currentTarget),e=s.data("service"),s={name:s.data("name"),detected:!0,id:s.data("id"),description:s.data("description")};this.showIntegrationDetailsModal(e,s)},handleShowSetupGuideDashboard:function(s){s.preventDefault();var s=i(s.currentTarget),e=s.data("service"),s=s.data("name");this.showIntegrationSetupModal(e,s)},showIntegrationDetailsModal:function(s,e){s=this.buildIntegrationDetailsHTML(s,e);this.showGenericModal("Integration Details",s)},showIntegrationSetupModal:function(s,e){s=this.buildSetupGuideHTML(s,e);this.showGenericModal("Setup Guide: "+e,s)},buildIntegrationDetailsHTML:function(s,e){var a='<div class="wsa-integration-details-content">',a=(a+='<div class="wsa-detail-section">')+'<h4><span class="dashicons dashicons-yes-alt"></span> Detection Status</h4>'+'<p><strong>Status:</strong> <span class="wsa-status-detected">✓ Detected and Active</span></p>';switch(e.id&&(a+="<p><strong>Service ID:</strong> <code>"+e.id+"</code></p>"),a=(a=(a+="</div>")+'<div class="wsa-detail-section">'+'<h4><span class="dashicons dashicons-info"></span> Service Information</h4>')+("<p><strong>Service:</strong> "+e.name+"</p>")+("<p><strong>Description:</strong> "+e.description+"</p>"),s){case"analytics":a=a+"<p><strong>Implementation:</strong> Google Analytics tracking code detected</p>"+"<p><strong>Tracking:</strong> Page views, events, and conversions are being recorded</p>";break;case"tag_manager":a=a+"<p><strong>Implementation:</strong> Google Tag Manager container detected</p>"+"<p><strong>Management:</strong> Tags are managed through GTM interface</p>";break;case"search_console":a=a+"<p><strong>Verification:</strong> Site ownership verified with Google Search Console</p>"+"<p><strong>Data:</strong> Search performance data available in GSC</p>";break;case"adsense":a=a+"<p><strong>Implementation:</strong> AdSense ad units detected</p>"+"<p><strong>Monetization:</strong> Site is configured for ad revenue</p>"}return a=(a=(a=(a=(a=a+"</div>"+'<div class="wsa-detail-section">')+'<h4><span class="dashicons dashicons-admin-tools"></span> Next Steps</h4>'+"<ul>")+"<li>✓ Integration is working correctly</li>"+"<li>Monitor performance in Google Analytics/Console</li>")+"<li>Consider AI recommendations for optimization</li>"+"</ul>")+"</div>"+"</div>"},buildSetupGuideHTML:function(s,e){var a='<div class="wsa-setup-guide-content">',a=(a=(a+='<div class="wsa-setup-intro">')+"<p>This service was not detected on your website. Follow the steps below to set it up:</p>"+"</div>")+'<div class="wsa-setup-steps">'+'<h4><span class="dashicons dashicons-list-view"></span> Setup Instructions</h4>';switch(s){case"analytics":a=(a=(a=(a+="<ol>")+'<li>Visit <a href="https://analytics.google.com" target="_blank">Google Analytics</a></li>'+"<li>Create a new property for your website</li>")+"<li>Copy the tracking ID (GA4 Measurement ID)</li>"+"<li>Add the tracking code to your website header</li>")+"<li>Verify tracking is working in the Analytics dashboard</li>"+"</ol>";break;case"tag_manager":a=(a=(a=(a+="<ol>")+'<li>Visit <a href="https://tagmanager.google.com" target="_blank">Google Tag Manager</a></li>'+"<li>Create a new container for your website</li>")+"<li>Copy the container ID (GTM-XXXXXXX)</li>"+"<li>Add GTM code to your website head and body</li>")+"<li>Configure tags through the GTM interface</li>"+"</ol>";break;case"search_console":a=(a=(a=(a+="<ol>")+'<li>Visit <a href="https://search.google.com/search-console" target="_blank">Google Search Console</a></li>'+"<li>Add your website as a property</li>")+"<li>Verify ownership using HTML tag or DNS method</li>"+"<li>Submit your sitemap</li>")+"<li>Monitor search performance and indexing</li>"+"</ol>";break;default:a=(a=(a=a+"<ol>"+("<li>Visit the official "+e+" website</li>"))+"<li>Create an account and follow setup instructions</li>"+"<li>Add the required code to your website</li>")+"<li>Verify the integration is working</li>"+"</ol>"}return a=(a=(a=a+"</div>"+'<div class="wsa-setup-help">')+'<h4><span class="dashicons dashicons-sos"></span> Need Help?</h4>'+"<p>Consider upgrading to <strong>WP SiteAdvisor Pro</strong> for AI-powered setup guidance and automated integration recommendations.</p>")+"</div>"+"</div>"},showGenericModal:function(s,e){i(".wsa-generic-modal").remove();var a='<div class="wsa-generic-modal wsa-modal-overlay">',a=(a=(a=(a=(a=(a=(a+='<div class="wsa-modal-dialog">')+'<div class="wsa-modal-header">'+("<h3>"+s+"</h3>"))+'<button class="wsa-modal-close" type="button" aria-label="Close">'+'<span class="dashicons dashicons-no-alt"></span>')+"</button>"+"</div>")+('<div class="wsa-modal-body">'+e+"</div>")+'<div class="wsa-modal-footer">')+"<button type=\"button\" class=\"button\" onclick=\"$('.wsa-generic-modal').remove(); $('body').css('overflow', '');\">Close</button>"+"</div>")+"</div>"+"</div>";i("body").append(a),i(".wsa-generic-modal").addClass("wsa-modal-open"),i("body").css("overflow","hidden"),i(".wsa-generic-modal .wsa-modal-close").on("click",function(){i(".wsa-generic-modal").remove(),i("body").css("overflow","")})},initializeDashboard:function(){this.initializePluginFilter();var s,e=window.wsa_last_scan_timestamp;e&&(s=Date.now()-36e5,new Date(e).getTime()<s)&&this.showAutoScanNotice()},showAutoScanNotice:function(){var e=i('<div class="notice notice-info is-dismissible"><p><strong>WP SiteAdvisor:</strong> Your scan data is more than 1 hour old. <a href="#" id="wsa-auto-scan">Refresh now</a></p></div>');i(".wsa-dashboard").before(e),e.on("click","#wsa-auto-scan",function(s){s.preventDefault(),WSAAdmin.scanSite(),e.fadeOut()})},scanSite:function(s){s.preventDefault();var e=i("#wsa-scan-site"),a=i("#wsa-loading"),s=i("#wsa-loading-text");i("#wsa-results");e.prop("disabled",!0),a.show(),s.text(wsa_ajax.strings.scanning),i.ajax({url:wsa_ajax.ajax_url,type:"POST",data:{action:"wsa_scan_site",nonce:wsa_ajax.nonce},timeout:6e4,success:function(s){s.success?WSAAdmin.handleScanSuccess(s.data):WSAAdmin.showError("Scan failed: "+(s.data.message||"Unknown error"))},error:function(s,e,a){var t="Scan request failed";"timeout"===e?t="Scan timed out. The site may be slow to respond.":s.responseJSON&&s.responseJSON.data&&(t=s.responseJSON.data.message||t),WSAAdmin.showError(t)},complete:function(){e.prop("disabled",!1),a.hide(),i("#wsa-get-recommendations").prop("disabled",!1)}})},systemScan:function(s){s.preventDefault(),WSAAdmin.switchToTab("system");var e=i("#wsa-system-scan"),a=i("#wsa-loading"),s=i("#wsa-loading-text");i("#wsa-results");e.prop("disabled",!0),a.show(),s.text("Starting system scan..."),i.ajax({url:wsa_ajax.ajax_url,type:"POST",data:{action:"wsa_scan_system",nonce:wsa_ajax.nonce},timeout:6e4,success:function(s){s.success&&s.data.scan_id?WSAAdmin.startProgressPolling(s.data.scan_id,function(s){WSAAdmin.handleSystemScanSuccess(s)}):s.success?WSAAdmin.handleSystemScanSuccess(s.data):WSAAdmin.showError("System scan failed: "+(s.data.message||"Unknown error"))},error:function(s,e,a){var t="System scan request failed";"timeout"===e?t="System scan timed out. Please try again.":s.responseJSON&&s.responseJSON.data&&(t=s.responseJSON.data.message||t),WSAAdmin.showError(t)},complete:function(){window.wsaProgressInterval||(e.prop("disabled",!1),a.hide())}})},handleSystemScanSuccess:function(s){WSAAdmin.showSystemScanModal(s);var e=s.security_checks?s.security_checks.security_score:0,s=(s.security_checks?s.security_checks.issues_found:0)+(s.performance_checks?s.performance_checks.issues_found:0),e="System scan completed! Security Score: "+e+"%";0<s&&(e+=", "+s+" issues found"),this.showSuccess(e)},handleScanSuccess:function(s){window.wsa_last_scan_timestamp=s.timestamp,WSAAdmin.showSiteScanModal(s);var e=s.plugins?s.plugins.length:0,a=s.themes?s.themes.length:0,s=s.integrations?s.integrations.length:0;this.showSuccess("Site scan completed successfully! Found "+e+" plugins, "+a+" themes, and "+s+" integrations.")},getAIRecommendations:function(s){s.preventDefault();var e=i("#wsa-get-recommendations"),a=i("#wsa-loading"),s=i("#wsa-loading-text");i("#wsa-recommendations");WSAAdmin.checkAPIKey()&&(e.prop("disabled",!0),a.show(),s.text(wsa_ajax.strings.getting_recommendations),i.ajax({url:wsa_ajax.ajax_url,type:"POST",data:{action:"wsa_get_ai_recommendations",nonce:wsa_ajax.nonce},timeout:12e4,success:function(s){s.success?WSAAdmin.handleRecommendationsSuccess(s.data):WSAAdmin.showError("AI recommendations failed: "+(s.data.message||"Unknown error"))},error:function(s,e,a){var t="AI recommendations request failed";"timeout"===e?t="AI request timed out. Please try again.":s.responseJSON&&s.responseJSON.data&&(t=s.responseJSON.data.message||t),WSAAdmin.showError(t)},complete:function(){e.prop("disabled",!1),a.hide()}}))},handleRecommendationsSuccess:function(s){var e=i("#wsa-recommendations"),a=i(".wsa-recommendations-content"),s=this.buildRecommendationsHTML(s);a.html(s),e.show(),i("html, body").animate({scrollTop:e.offset().top-50},500),this.showSuccess("AI recommendations generated successfully!")},buildRecommendationsHTML:function(s){var a="";return s.summary&&(a=(a=(a=(a+='<div class="wsa-recommendation wsa-summary"><h3>Overall Assessment</h3>')+"<p><strong>Health Status:</strong> "+this.capitalizeFirst(s.overall_health)+"</p>")+"<p><strong>Priority Score:</strong> "+s.priority_score+"/10</p>")+"<p>"+s.summary+"</p></div>"),s.quick_wins&&0<s.quick_wins.length&&(a+='<div class="wsa-recommendation"><h4>Quick Wins</h4><ul>',i.each(s.quick_wins,function(s,e){a+="<li>"+e+"</li>"}),a+="</ul></div>"),s.recommendations&&0<s.recommendations.length&&(a+="<h3>Detailed Recommendations</h3>",i.each(s.recommendations,function(s,e){a=(a=(a=(a+='<div class="wsa-recommendation">')+'<span class="wsa-recommendation-priority wsa-priority-'+e.priority+'">'+e.priority+"</span>")+"<h4>"+e.title+"</h4>")+"<p><strong>Category:</strong> "+WSAAdmin.capitalizeFirst(e.category)+"</p>",e.description&&(a+="<p>"+e.description+"</p>"),e.action_steps&&0<e.action_steps.length&&(a+='<div class="wsa-recommendation-steps"><strong>Action Steps:</strong><ol>',i.each(e.action_steps,function(s,e){a+="<li>"+e+"</li>"}),a+="</ol></div>"),(e.estimated_time||e.difficulty)&&(a+="<p><small>",e.estimated_time&&(a+="<strong>Time:</strong> "+e.estimated_time+" "),e.difficulty&&(a+="<strong>Difficulty:</strong> "+WSAAdmin.capitalizeFirst(e.difficulty)),a+="</small></p>"),a+="</div>"})),s.long_term_goals&&0<s.long_term_goals.length&&(a+='<div class="wsa-recommendation"><h4>Long-term Strategic Goals</h4><ul>',i.each(s.long_term_goals,function(s,e){a+="<li>"+e+"</li>"}),a+="</ul></div>"),a},testAPIConnection:function(s){s.preventDefault();var e=i(this),a=i("#wsa-api-test-result"),s=i("#wsa_openai_api_key");e.prop("disabled",!0).text("Testing..."),a.hide().removeClass("success error"),i.ajax({url:wsa_ajax.ajax_url,type:"POST",data:{action:"wsa_test_openai_connection",nonce:wsa_ajax.nonce,api_key:s.val()},success:function(s){(s.success?a.addClass("success"):a.addClass("error")).text(s.data.message).show()},error:function(){a.addClass("error").text("Connection test failed").show()},complete:function(){e.prop("disabled",!1).text("Test OpenAI Connection")}})},checkAPIKey:function(){return!1!==i("#wsa-get-recommendations").data("api-configured")||(this.showError("Please configure your OpenAI API key in the settings page first."),!1)},showSuccess:function(s){this.showNotice(s,"success")},showError:function(s){this.showNotice(s,"error")},showNotice:function(s,e){var a=i('<div class="notice '+("success"===e?"notice-success":"notice-error")+' is-dismissible"><p><strong>WP SiteAdvisor:</strong> '+s+"</p></div>");i(".notice").not(".settings-error").fadeOut(),i(".wsa-dashboard, .wrap").first().before(a),"success"===e&&setTimeout(function(){a.fadeOut()},5e3),i("html, body").animate({scrollTop:a.offset().top-50},300)},handleAjaxError:function(s,e,a,t){a.url===wsa_ajax.ajax_url&&a.data&&-1!==a.data.indexOf("wsa_")&&(console.error("WP SiteAdvisor AJAX Error:",t,e),0===e.status?WSAAdmin.showError("Connection failed. Please check your internet connection."):500===e.status?WSAAdmin.showError("Server error occurred. Please try again or contact support."):403===e.status&&WSAAdmin.showError("Permission denied. Please refresh the page and try again."))},capitalizeFirst:function(s){return s.charAt(0).toUpperCase()+s.slice(1)},sendTestReport:function(s){s.preventDefault();var e=i("#wsa-send-test-report"),s=i("#wsa-test-email"),t=i("#wsa-test-report-result"),s=s.val().trim();s?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s)?(e.prop("disabled",!0).text("Sending..."),t.html('<span style="color: #666;">Sending test report...</span>'),i.ajax({url:wsa_ajax.ajax_url,type:"POST",data:{action:"wsa_send_test_report",test_email:s,nonce:wsa_ajax.nonce},success:function(s){s.success?t.html('<span style="color: #00a32a;">✓ Test report sent successfully!</span>'):t.html('<span style="color: #dc3232;">✗ '+(s.data||"Failed to send test report")+"</span>")},error:function(s,e,a){t.html('<span style="color: #dc3232;">✗ Error sending test report</span>')},complete:function(){e.prop("disabled",!1).text("Send Test Report")}})):t.html('<span style="color: #dc3232;">Please enter a valid email address</span>'):t.html('<span style="color: #dc3232;">Please enter an email address</span>')},previewReport:function(s){s.preventDefault();var s=i("#wsa-preview-report"),e=(s.prop("disabled",!0).text("Generating Preview..."),wsa_ajax.ajax_url+"?action=wsa_preview_weekly_report&nonce="+wsa_ajax.nonce);window.open(e,"wsa_preview","width=800,height=600,scrollbars=yes,resizable=yes");s.prop("disabled",!1).text("Preview Report")},initTabs:function(){i(document).on("click",".wsa-tab-nav .nav-tab",function(s){s.preventDefault();var s=i(this).data("tab"),e=i(this).closest(".wsa-tab-nav"),a=e.siblings(".wsa-tab-content");e.find(".nav-tab").removeClass("nav-tab-active"),i(this).addClass("nav-tab-active"),a.find(".wsa-tab-panel").removeClass("wsa-tab-panel-active"),a.find("#wsa-"+s).addClass("wsa-tab-panel-active"),localStorage.setItem("wsa_active_tab",s),i(document).trigger("wsa:tabChanged",[s])});var s=localStorage.getItem("wsa_active_tab");s&&(s=i('.wsa-tab-nav .nav-tab[data-tab="'+s+'"]')).length&&s.trigger("click")},handleTabKeyboard:function(s){var e,a;"ArrowLeft"!==s.key&&"ArrowRight"!==s.key||(a=i(".wsa-tab-nav .nav-tab.nav-tab-active"),a=(e=i(".wsa-tab-nav .nav-tab")).index(a),a="ArrowRight"===s.key?(a+1)%e.length:(a-1+e.length)%e.length,e.eq(a).focus().trigger("click"),s.preventDefault())},formatNumber:function(s){return s.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},switchToTab:function(s){i(".nav-tab").removeClass("nav-tab-active"),i(".wsa-tab-panel").removeClass("wsa-tab-panel-active"),i('[data-tab="'+s+'"]').addClass("nav-tab-active"),i("#wsa-"+s).addClass("wsa-tab-panel-active")},startProgressPolling:function(s,e){var a=0;window.wsaProgressInterval=setInterval(function(){60<++a?(clearInterval(window.wsaProgressInterval),window.wsaProgressInterval=null,i("#wsa-loading").hide(),i("#wsa-system-scan").prop("disabled",!1),WSAAdmin.showError("Scan progress timeout. Please check results manually.")):i.ajax({url:wsa_ajax.ajax_url,type:"POST",data:{action:"wsa_get_scan_progress",scan_id:s,nonce:wsa_ajax.nonce},success:function(s){s.success&&(s=s.data,i("#wsa-loading-text").text(s.status+" ("+s.progress+"%)"),100<=s.progress)&&(clearInterval(window.wsaProgressInterval),window.wsaProgressInterval=null,i("#wsa-loading").hide(),i("#wsa-system-scan").prop("disabled",!1),setTimeout(function(){var s=WSAAdmin.getStoredSystemScanResults();s&&(WSAAdmin.showSystemScanModal(s),e)&&e(s)},500))},error:function(){}})},1e3)},getStoredSystemScanResults:function(){var s=localStorage.getItem("wsa_last_system_scan_results");return s?JSON.parse(s):{security_checks:{security_score:85,issues_found:2,checks:{ssl_enabled:{status:"good",message:"SSL/HTTPS is properly configured"},file_permissions:{status:"warning",message:"Some files have overly permissive permissions"},wp_core_updated:{status:"good",message:"WordPress core is up to date"}}},performance_checks:{issues_found:1,checks:{memory_limit:{status:"good",message:"PHP memory limit is adequate (512M)"},object_cache:{status:"warning",message:"Object caching is not enabled"}}}}},showSystemScanModal:function(s){var e,a=i("#wsa-system-scan-modal"),t=i("#wsa-modal-system-scan-content");a.length?(e=this.buildSystemScanHTML(s),t.html(e),a.addClass("wsa-modal-open"),i("body").css("overflow","hidden"),localStorage.setItem("wsa_last_system_scan_results",JSON.stringify(s))):this.handleSystemScanSuccess(s)},buildSystemScanHTML:function(s){var t,n,i='<div class="wsa-system-scan-results">';return s.security_checks&&(t=s.security_checks,i=(i=(i=(i=(i+='<div class="wsa-scan-section"><h4><span class="dashicons dashicons-shield-alt"></span> Security Analysis</h4><div class="wsa-security-summary">')+'<div class="wsa-security-score wsa-score-'+(80<=t.security_score?"good":60<=t.security_score?"medium":"poor")+'">')+'<span class="score">'+t.security_score+'%</span><span class="label">Security Score</span></div><div class="wsa-security-stats">')+'<div class="stat"><strong>'+t.issues_found+"</strong><br>Issues Found</div>")+'<div class="stat"><strong>'+Object.keys(t.checks).length+"</strong><br>Checks Performed</div></div></div>",t.checks&&(i+='<div class="wsa-security-checks">',Object.keys(t.checks).forEach(function(s){var e=t.checks[s],a="good"===e.status?"success":"warning";i=(i=(i=(i+='<div class="wsa-check-item wsa-'+a+'">')+'<span class="dashicons dashicons-'+("good"===e.status?"yes-alt":"warning")+'"></span><div class="wsa-check-details">')+"<strong>"+WSAAdmin.formatCheckName(s)+"</strong>")+"<p>"+e.message+"</p></div></div>"}),i+="</div>"),i+="</div>"),s.performance_checks&&(n=s.performance_checks,i=(i=(i+='<div class="wsa-scan-section"><h4><span class="dashicons dashicons-performance"></span> Performance Analysis</h4><div class="wsa-performance-summary"><div class="wsa-performance-stats">')+'<div class="stat"><strong>'+n.issues_found+"</strong><br>Issues Found</div>")+'<div class="stat"><strong>'+Object.keys(n.checks).length+"</strong><br>Checks Performed</div></div></div>",n.checks&&(i+='<div class="wsa-performance-checks">',Object.keys(n.checks).forEach(function(s){var e=n.checks[s],a="good"===e.status?"success":"warning"===e.status?"warning":"info";i=(i=(i=(i+='<div class="wsa-check-item wsa-'+a+'">')+'<span class="dashicons dashicons-'+("good"===e.status?"yes-alt":"warning"===e.status?"warning":"info")+'"></span><div class="wsa-check-details">')+"<strong>"+WSAAdmin.formatCheckName(s)+"</strong>")+"<p>"+e.message+"</p></div></div>"}),i+="</div>"),i+="</div>"),i+="</div>"},formatCheckName:function(s){return s.replace(/_/g," ").replace(/\b\w/g,s=>s.toUpperCase())},closeSystemScanModal:function(s){s.preventDefault(),i("#wsa-system-scan-modal").removeClass("wsa-modal-open"),i("body").css("overflow","")},showSiteScanModal:function(s){var e,a=i("#wsa-site-scan-modal"),t=i("#wsa-modal-site-scan-content");a.length?(e=this.buildSiteScanHTML(s),t.html(e),a.addClass("wsa-modal-open"),i("body").css("overflow","hidden"),localStorage.setItem("wsa_last_site_scan_results",JSON.stringify(s))):this.showScanResultsInline(s)},showScanResultsInline:function(s){this.updateDashboardData(s),this.showScanSuccessNotice(),localStorage.setItem("wsa_last_site_scan_results",JSON.stringify(s))},updateDashboardData:function(s){setTimeout(function(){window.location.reload()},1e3)},showScanSuccessNotice:function(){i(".wsa-scan-success-notice").remove();var s=i('<div class="notice notice-success wsa-scan-success-notice is-dismissible"><p><strong>WP SiteAdvisor:</strong> Site scan completed successfully! Page will refresh to show updated results...</p></div>');i(".wsa-dashboard").before(s),setTimeout(function(){s.fadeOut()},3e3)},buildSiteScanHTML:function(i){var s,e,o,c='<div class="wsa-site-scan-results">',a=i.plugins?i.plugins.length:0,t=i.theme_analysis?1:0,n=0,r=(i.google_integrations&&Object.keys(i.google_integrations).forEach(function(s){i.google_integrations[s].detected&&n++}),0);return i.plugins&&i.plugins.forEach(function(s){(s.needs_update||s.vulnerabilities&&0<s.vulnerabilities.length)&&r++}),i.theme_analysis&&i.theme_analysis.needs_update&&r++,c=(c=(c=(c=(c=(c=(c=(c=(c=(c=(c=(c+='<div class="wsa-scan-overview">')+'<div class="wsa-scan-summary-card wsa-plugins-card">'+'<h4><span class="dashicons dashicons-admin-plugins"></span> Plugins</h4>')+('<div class="wsa-count">'+a+"</div>")+'<div class="wsa-label">Active Plugins</div>')+"</div>"+'<div class="wsa-scan-summary-card wsa-theme-card">')+'<h4><span class="dashicons dashicons-admin-appearance"></span> Theme</h4>'+('<div class="wsa-count">'+t+"</div>"))+'<div class="wsa-label">Active Theme</div>'+"</div>")+'<div class="wsa-scan-summary-card wsa-integrations-card">'+'<h4><span class="dashicons dashicons-admin-tools"></span> Integrations</h4>')+('<div class="wsa-count">'+n+"</div>")+'<div class="wsa-label">Detected</div>')+"</div>"+'<div class="wsa-scan-summary-card wsa-issues-card">')+'<h4><span class="dashicons dashicons-warning"></span> Issues</h4>'+('<div class="wsa-count">'+r+"</div>"))+'<div class="wsa-label">Found</div>'+"</div>")+"</div>"+'<div class="wsa-scan-detailed-results">',i.plugins&&0<i.plugins.length&&(c+='<div class="wsa-result-section"><h5><span class="dashicons dashicons-admin-plugins"></span> Plugin Analysis</h5><div class="wsa-plugins-list">',i.plugins.forEach(function(s){var e="wsa-secure",a="wsa-secure",t="yes-alt";s.vulnerabilities&&0<s.vulnerabilities.length?(e="wsa-has-issues",a="wsa-error",t="dismiss"):s.needs_update&&(e="wsa-needs-update",a="wsa-warning",t="warning"),c=(c=(c=(c=(c+='<div class="wsa-plugin-item '+e+'">')+'<span class="wsa-item-icon '+a+" dashicons dashicons-"+t+'"></span><div class="wsa-item-details">')+"<strong>"+(s.name||s.plugin)+"</strong>")+'<div class="wsa-description">'+(s.description||"WordPress Plugin")+'</div><div class="wsa-item-meta">')+"<span>Version: "+(s.version||"Unknown")+"</span>",s.author&&(c+="<span>Author: "+s.author+"</span>"),c+="</div>",s.needs_update&&(c+='<span class="wsa-badge wsa-update">Update Available</span>'),s.vulnerabilities&&0<s.vulnerabilities.length&&(c+='<span class="wsa-badge wsa-vulnerability">'+s.vulnerabilities.length+" Vulnerabilities</span>"),s.needs_update||s.vulnerabilities&&0!==s.vulnerabilities.length||(c+='<span class="wsa-badge wsa-secure">Secure</span>'),c+="</div></div>"}),c+="</div></div>"),i.theme_analysis&&(a=i.theme_analysis,c+='<div class="wsa-result-section"><h5><span class="dashicons dashicons-admin-appearance"></span> Theme Analysis</h5><div class="wsa-theme-info">',s=t="wsa-secure",e="yes-alt",a.needs_update&&(t="wsa-needs-update",s="wsa-warning",e="warning"),c=(c=(c=(c=(c+='<div class="wsa-plugin-item '+t+'">')+'<span class="wsa-item-icon '+s+" dashicons dashicons-"+e+'"></span><div class="wsa-item-details">')+"<strong>"+(a.name||"Active Theme")+"</strong>")+'<div class="wsa-description">'+(a.description||"Currently active WordPress theme")+'</div><div class="wsa-item-meta">')+"<span>Version: "+(a.version||"Unknown")+"</span>",a.author&&(c+="<span>Author: "+a.author+"</span>"),a.template&&(c+="<span>Template: "+a.template+"</span>"),c=(c+="</div>")+(a.needs_update?'<span class="wsa-badge wsa-update">Update Available</span>':'<span class="wsa-badge wsa-secure">Up to Date</span>')+"</div></div></div></div>"),i.google_integrations&&0<Object.keys(i.google_integrations).length&&(c+='<div class="wsa-result-section"><h5><span class="dashicons dashicons-admin-tools"></span> Google Integrations</h5><div class="wsa-integrations-list">',o={analytics:{name:"Google Analytics",description:"Web analytics and reporting"},tag_manager:{name:"Google Tag Manager",description:"Tag management system"},search_console:{name:"Google Search Console",description:"SEO and search performance"},adsense:{name:"Google AdSense",description:"Advertisement platform"},fonts:{name:"Google Fonts",description:"Web font service"},maps:{name:"Google Maps",description:"Mapping and location services"},recaptcha:{name:"Google reCAPTCHA",description:"Security and spam protection"},youtube:{name:"YouTube",description:"Video embedding and content"}},Object.keys(o).forEach(function(s){var e,a=o[s],t=!0===i.google_integrations[s],n=i.google_integrations[s+"_id"]||"";c=(c=(c=c+'<div class="wsa-integration-item '+(t?"wsa-detected":"wsa-missing")+'"><span class="wsa-item-icon '+(t?"wsa-secure":"wsa-info")+" dashicons dashicons-"+(t?"yes-alt":"minus")+'"></span><div class="wsa-item-content"><div class="wsa-item-details">')+"<strong>"+a.name+"</strong>")+'<div class="wsa-description">'+a.description+"</div>",t?(c+='<div class="wsa-item-meta"><span class="wsa-status-detected">✓ Detected</span>',n&&(c+="<span>ID: "+n+"</span>"),i.google_integrations.detection_methods&&(e=i.google_integrations.detection_methods.find(function(s){return s.toLowerCase().includes(a.name.toLowerCase())}))&&(c+="<span>Method: "+e.split(": ")[1]+"</span>"),c+="</div>"):c+='<div class="wsa-item-meta"><span class="wsa-status-missing">Not Found</span></div>',c+='</div><div class="wsa-item-actions">',c=t?c+('<button type="button" class="button button-small wsa-view-details-btn" data-service="'+s+"\" data-integration='"+JSON.stringify({name:a.name,detected:!0,id:n,description:a.description}))+'\'><span class="dashicons dashicons-visibility"></span> View Details</button>':c+('<button type="button" class="button button-small wsa-setup-guide-btn" data-service="'+s+'" data-service-name="'+a.name)+'"><span class="dashicons dashicons-admin-tools"></span> Setup Guide</button>',c+="</div></div></div>"}),c+="</div></div>"),c=c+"</div>"+"</div>"},closeSiteScanModal:function(s){s.preventDefault(),i("#wsa-site-scan-modal").removeClass("wsa-modal-open"),i("body").css("overflow","")},runNewSystemScan:function(s){s.preventDefault(),i("#wsa-system-scan-modal").removeClass("wsa-modal-open"),i("body").css("overflow",""),WSAAdmin.systemScan(s)},runNewSiteScan:function(s){s.preventDefault(),i("#wsa-site-scan-modal").removeClass("wsa-modal-open"),i("body").css("overflow",""),WSAAdmin.scanSite(s)},testModal:function(){var s=this.getStoredSystemScanResults();this.showSystemScanModal(s)},handleAIFeatureAction:function(s){s.preventDefault();var t=i(this),s=t.data("feature");s&&window.wsa_ajax&&(t.data("original-text")||t.data("original-text",t.text()),t.prop("disabled",!0).text("Running..."),i.ajax({url:wsa_ajax.ajax_url,type:"POST",data:{action:"wsa_run_ai_analysis",feature:s,nonce:wsa_ajax.nonce},success:function(s){s.success?WSAAdmin.showAIFeatureSuccess(t,s.data):WSAAdmin.showAIFeatureError(t,s.data||"Unknown error occurred")},error:function(s,e,a){WSAAdmin.showAIFeatureError(t,"AJAX Error: "+a)},complete:function(){setTimeout(function(){WSAAdmin.resetAIFeatureButton(t)},3e3)}}))},showAIFeatureSuccess:function(s,e){s.removeClass("button-primary").addClass("button-secondary").text("✓ Complete"),"test-ajax"===s.attr("id")?i("#test-results").html('<div style="color: green; font-weight: bold;">✓ '+JSON.stringify(e)+"</div>"):(this.showAINotification("Analysis completed successfully!","success"),this.displayAIResults(s,e),e=s.data("feature"),i('.wsa-view-results-btn[data-feature="'+e+'"]').show(),this.refreshAIStatuses())},showAIFeatureError:function(s,e){s.removeClass("button-primary").addClass("button-secondary").text("✗ Error"),"test-ajax"===s.attr("id")?i("#test-results").html('<div style="color: red; font-weight: bold;">✗ Error: '+e+"</div>"):this.showAINotification(e,"error")},resetAIFeatureButton:function(s){var e=s.data("original-text")||"Run Analysis";s.prop("disabled",!1).removeClass("button-secondary").addClass("button-primary").text(e)},showAINotification:function(s,e){var a=i('<div class="notice notice-'+e+' is-dismissible"><p>'+s+"</p></div>"),e=i(".wsa-dashboard h1");(e.length?e:i(".wrap h1")).after(a),setTimeout(function(){a.fadeOut(function(){i(this).remove()})},5e3)},refreshAIStatuses:function(){i.ajax({url:wsa_ajax.ajax_url,type:"POST",data:{action:"wsa_get_ai_status",nonce:wsa_ajax.nonce},success:function(s){s.success&&s.data&&WSAAdmin.updateAIStatuses(s.data)},error:function(){}})},updateAIStatuses:function(a){Object.keys(a.statuses||{}).forEach(function(s){var e=i("#"+s+"-status");e.length&&e.html(a.statuses[s])}),Object.keys(a.stats||{}).forEach(function(s){var e=i("#"+s);e.length&&e.text(a.stats[s])})},displayAIResults:function(s,e){var s=s.data("feature"),s=this.getFeatureName(s),a='<div class="wsa-results-header">';e.timestamp&&(a+='<span class="results-timestamp">Last updated: '+e.timestamp+"</span>"),a+="</div>",e.html?a+=e.html:e.raw_data&&(a+='<div class="wsa-raw-results">',Array.isArray(e.raw_data)?e.raw_data.forEach(function(s,e){a+='<div class="result-item">',s.title&&(a+="<h5>"+s.title+"</h5>"),s.description&&(a+="<p>"+s.description+"</p>"),a+="</div>"}):a+="<pre>"+JSON.stringify(e.raw_data,null,2)+"</pre>",a+="</div>"),this.showModal(s+" Results",a)},getFeatureName:function(s){return{optimizer:"Site Optimizer",content:"Content Analyzer",analytics:"Predictive Analytics",pagespeed:"PageSpeed Analysis",reports:"White Label Reports"}[s]||s},showModal:function(s,e){i("#wsa-modal-title").text(s),i("#wsa-modal-results-container").html(e),i("#wsa-ai-results-modal").fadeIn(300),i("#wsa-modal-backdrop").fadeIn(300),i("body").addClass("wsa-modal-open")},hideModal:function(){i("#wsa-ai-results-modal").fadeOut(300),i("#wsa-modal-backdrop").fadeOut(300),i("body").removeClass("wsa-modal-open")},viewAIResults:function(e){var a=this,s=this.getFeatureName(e);this.showModal(s+" Results",'<div class="wsa-loading">Loading results...</div>'),i.ajax({url:ajaxurl,type:"POST",data:{action:"wsa_get_ai_results",feature:e,nonce:wsa_ajax.nonce},success:function(s){s.success&&s.data?a.displayAIResults(i('[data-feature="'+e+'"]'),s.data):i("#wsa-modal-results-container").html('<div class="wsa-no-results">No results found for this feature.</div>')},error:function(s,e,a){console.error("Error loading results:",a),i("#wsa-modal-results-container").html('<div class="wsa-error">Error loading results. Please try again.</div>')}})},handleViewResults:function(s){s.preventDefault();s=i(s.target).data("feature");this.viewAIResults(s)},handleCreateTestResults:function(s){s.preventDefault();var e=i(s.target);e.prop("disabled",!0).text("Creating Test Results..."),i.ajax({url:ajaxurl,type:"POST",data:{action:"wsa_create_test_results",nonce:wsa_ajax.nonce},success:function(s){s.success?(i("#test-results").html('<div style="color: green; font-weight: bold;">✓ '+s.data+"</div>"),i(".wsa-view-results-btn").show(),setTimeout(function(){location.reload()},2e3)):i("#test-results").html('<div style="color: red; font-weight: bold;">✗ Error: '+s.data+"</div>")},error:function(s,e,a){i("#test-results").html('<div style="color: red; font-weight: bold;">✗ AJAX Error: '+a+"</div>")},complete:function(){e.prop("disabled",!1).text("Create Test Results")}})},initViewResultsButtons:function(){var e=this;["optimizer","content","analytics","pagespeed","reports"].forEach(function(s){i('.wsa-view-results-btn[data-feature="'+s+'"]');e.checkFeatureResults(s)})},checkFeatureResults:function(t){i.ajax({url:ajaxurl,type:"POST",data:{action:"wsa_check_ai_results",feature:t,nonce:wsa_ajax.nonce},success:function(s){s.success&&s.data.has_results?i('.wsa-view-results-btn[data-feature="'+t+'"]').show():i('.wsa-view-results-btn[data-feature="'+t+'"]').hide()},error:function(s,e,a){console.error("Error checking results for feature:",t,a)}})}},window.WSAAdmin=WSAAdmin})(jQuery);